name: Security AI Scan (unified post)

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  OPENAI_API_KEY: ${{ secrets.SKLEE_OPENAI_API_KEY }}
  MAX_POST_CHARS: "1800"
  MAX_FILES_TO_ANALYZE: "200"
  MAX_FILE_BYTES: "150000"

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install semgrep & requests
        run: |
          python -m pip install --upgrade pip
          pip install semgrep requests || true

      - name: Run semgrep builtin
        id: run_semgrep_builtin
        run: |
          semgrep --config p/ci --json --output semgrep-results.json || true
          ls -la semgrep-results.json || true

      - name: Run semgrep custom if exists
        id: run_semgrep_custom
        run: |
          if [ -f .semgrep.yml ] || [ -f .semgrep.yaml ]; then
            semgrep --config .semgrep.yml --json --output semgrep-custom.json || true
            ls -la semgrep-custom.json || true
          else
            echo "no custom semgrep config"
          fi

      - name: List .github/scripts
        run: |
          ls -la .github/scripts || true

      - name: Run external security script if present
        id: run_external
        run: |
          if [ -f .github/scripts/security_scan.py ]; then
            echo "Running .github/scripts/security_scan.py"
            python .github/scripts/security_scan.py || echo "external script failed but continuing"
          else
            echo "No external script found - creating fallback report.md"
            echo "# ê°„ë‹¨ fallback ë¦¬í¬íŠ¸" > report.md || true
            echo "" >> report.md
            echo "- No external script and no semgrep results processed." >> report.md || true
            echo "_ì „ì²´ ë¦¬í¬íŠ¸ëŠ” artifactë¡œ ë³´ê´€ë©ë‹ˆë‹¤._" >> report.md || true
            head -n 50 report.md > post_body_short.md || true
          fi

      - name: Debug: show generated files and sizes
        run: |
          ls -la report.md || true
          wc -c report.md || true
          ls -la post_body_short.md || true
          if [ -f post_body_short.md ]; then head -c 200 post_body_short.md || true; echo; fi
          ls -la semgrep-results.json semgrep-custom.json || true

      - name: Post result (PR comment or Issue)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const shortPath = 'post_body_short.md';
            let body = null;
            if (fs.existsSync(shortPath)) {
              body = fs.readFileSync(shortPath, 'utf8');
            } else if (fs.existsSync('report.md')) {
              body = fs.readFileSync('report.md', 'utf8').slice(0, 1800);
            } else {
              body = "ìë™ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•„í‹°íŒ©íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            }
            const isPR = !!context.payload.pull_request;
            if (isPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `### ğŸ¤– AI Security Review (ìë™ ë¦¬í¬íŠ¸)\n\n${body}\n\n_ì „ì²´ ë¦¬í¬íŠ¸ëŠ” artifactë¡œ ë³´ê´€ë©ë‹ˆë‹¤._`
              });
              console.log("Posted PR comment");
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[AI Security Scan] ìë™ ë¦¬í¬íŠ¸ - ${new Date().toISOString().slice(0,10)}`,
                body: `ë¸Œëœì¹˜: ${context.ref}\n\n${body}\n\n_ì „ì²´ ë¦¬í¬íŠ¸ëŠ” artifactë¡œ ë³´ê´€ë©ë‹ˆë‹¤._`
              });
              console.log("Created issue with report");
            }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-artifacts
          path: |
            report.md
            post_body_short.md
            semgrep-results.json
            semgrep-custom.json
