name: Security AI Scan (debug + force-post)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: ['**']

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  OPENAI_API_KEY: ${{ secrets.SKLEE_OPENAI_API_KEY }}
  MAX_FILE_BYTES: "150000"
  MAX_FILES_TO_ANALYZE: "200"

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies (semgrep, requests)
        run: |
          python -m pip install --upgrade pip
          pip install semgrep requests

      - name: Run semgrep (builtin rules)
        run: |
          semgrep --config p/ci --json --output semgrep-results.json || true
          echo "semgrep finished, results saved to semgrep-results.json (if any)"

      - name: Run external security script (if present)
        id: run_script
        run: |
          echo "----- START external security script step -----"
          echo "Listing .github/scripts directory (if present):"
          ls -la .github/scripts || true

          if [ -f .github/scripts/security_scan.py ]; then
            echo "security_scan.py FOUND - running..."
            python .github/scripts/security_scan.py || echo "security_scan.py exited with non-zero"
            echo "security_scan.py finished"
          else
            echo ".github/scripts/security_scan.py not found â€” relying on semgrep fallback report"
            # Optionally generate a lightweight fallback report here (but we handle fallback in debug step)
          fi

          # show files count and whether report.md exists (helpful quick check)
          if [ -f report.md ]; then
            echo "report.md created; files_count: 1"
          else
            echo "report.md NOT found at root"
          fi

          echo "----- END external security script step -----"

      - name: Debug & Force-post report (show report and post truncated)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // 1) Workspace inspection - helpful for debugging
            core.info('=== WORKSPACE ===');
            try {
              const ls = require('child_process').execSync('ls -la', { encoding: 'utf8' });
              core.info(ls);
            } catch(e) {
              core.info('ls failed: ' + String(e));
            }

            core.info('Listing .github/scripts (if exists):');
            try {
              const ls2 = require('child_process').execSync('ls -la .github/scripts || true', { encoding: 'utf8' });
              core.info(ls2);
            } catch(e) {
              core.info('ls .github/scripts failed: ' + String(e));
            }

            // 2) If semgrep-results.json exists and report.md does not, create a simple report.md fallback
            if (!fs.existsSync('report.md')) {
              if (fs.existsSync('semgrep-results.json')) {
                core.info('report.md not found, generating fallback report.md from semgrep-results.json');
                try {
                  const txt = fs.readFileSync('semgrep-results.json','utf8');
                  const data = JSON.parse(txt || '{}');
                  const results = Array.isArray(data.results) ? data.results : [];
                  let lines = [];
                  lines.push('### ìë™ ë³´ì•ˆ ë¦¬í¬íŠ¸ (fallback from semgrep)');
                  lines.push('');
                  if (results.length > 0) {
                    lines.push('#### Semgrep ë°œê²¬ í•­ëª©:');
                    for (let i=0;i<Math.min(200,results.length);i++) {
                      const r = results[i];
                      const path = r.path || (r.extra && r.extra.metadata && r.extra.metadata.file) || '-';
                      const extra = r.extra || {};
                      const msg = extra.message || r.message || '';
                      let start = '-';
                      if (r.start && typeof r.start === 'object') start = r.start.line || '-';
                      else if (r.start) start = String(r.start);
                      const sev = extra.severity || '';
                      lines.push(`- ${path}:${start} [${sev}] ${msg}`);
                    }
                  } else {
                    lines.push('- Semgrep: ë¬¸ì œ ì—†ìŒ (ê¸°ë³¸ ë£°).');
                  }
                  lines.push('');
                  lines.push('_ìë™ ë¦¬í¬íŠ¸ â€” ë‹´ë‹¹ì ê²€í†  í•„ìš”_');
                  fs.writeFileSync('report.md', lines.join('\\n'), {encoding:'utf8'});
                  core.info('Fallback report.md created.');
                } catch (e) {
                  core.info('Failed to create fallback report: ' + String(e));
                }
              } else {
                core.info('No semgrep-results.json and no report.md found.');
              }
            } else {
              core.info('report.md already exists at workspace root.');
            }

            // 3) Show report.md existence and head content (for logs)
            if (fs.existsSync('report.md')) {
              const full = fs.readFileSync('report.md','utf8');
              core.info('report.md size (chars): ' + full.length);
              core.info('---- report.md head (first 4000 chars) ----');
              core.info(full.slice(0,4000));
              core.info('---- end head ----');
            } else {
              core.info('report.md STILL NOT found at workspace root after fallback attempts.');
            }

            // 4) Force post: if PR -> comment on PR; else -> create Issue
            let body = fs.existsSync('report.md') ? fs.readFileSync('report.md','utf8') : 'No report generated.';
            // truncate if too long
            if (body.length > 8000) {
              body = body.slice(0,8000) + '\n\n(ë¦¬í¬íŠ¸ê°€ ë„ˆë¬´ ê¸¸ì–´ ìš”ì•½ë³¸ë§Œ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤ - ì „ì²´ëŠ” artifact ì°¸ê³ )';
            }
            const isPR = !!context.payload.pull_request;
            if (isPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `### ğŸ¤– AI Security Review (ìë™ ë¦¬í¬íŠ¸, ìš”ì•½)\n\n${body}\n\n_ìë™ ìƒì„± â€” ë‹´ë‹¹ì ê²€í†  í•„ìš”_`
              });
              core.info('Posted truncated report as PR comment');
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[AI Security Scan] ìë™ ë¦¬í¬íŠ¸ - ${new Date().toISOString().slice(0,10)}`,
                body: `ë¸Œëœì¹˜: ${context.ref}\n\n${body}\n\n_ìë™ ìƒì„± ë¦¬í¬íŠ¸_`
              });
              core.info('Created issue with truncated report');
            }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-artifacts
          path: |
            semgrep-results.json
            report.md
            files_to_analyze.json
            files_content.json
            heuristics.json
            ai_summary_structured.json
