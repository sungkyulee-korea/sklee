name: Security AI Scan (KR report + post)

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: ['**']

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  # Optional: set OPENAI_API_KEY in Secrets if you later use OpenAI augmentation
  OPENAI_API_KEY: ${{ secrets.SKLEE_OPENAI_API_KEY || '' }}

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install semgrep
        run: |
          python -m pip install --upgrade pip
          pip install semgrep

      - name: Run semgrep (builtin rules)
        run: |
          semgrep --config p/ci --json --output semgrep-results.json || true
          echo "semgrep finished; semgrep-results.json written (if any findings)."
          ls -la semgrep-results.json || true

      - name: Generate report (create report.md from semgrep-results.json)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            function normSeverity(s) {
              if (!s) return 'LOW';
              s = String(s).toLowerCase();
              if (s.includes('critical') || s.includes('error') || s.includes('high')) return 'CRITICAL';
              if (s.includes('medium') || s.includes('moderate')) return 'MEDIUM';
              return 'LOW';
            }

            function detectCWE(msg) {
              if (!msg) return '';
              const m = /cwe[-_ ]?(\d{1,4})/i.exec(msg);
              if (m) return 'CWE-' + m[1];
              const lower = msg.toLowerCase();
              if (lower.includes('sql')) return 'CWE-89';
              if (lower.includes('xss') || lower.includes('<script')) return 'CWE-79';
              if (lower.includes('ldap')) return 'CWE-90';
              if (lower.includes('xpath')) return 'CWE-643';
              return '';
            }

            function recommend(msg) {
              if (!msg) return 'ì…ë ¥ ê²€ì¦(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸) ë° ì¶œë ¥ ì¸ì½”ë”© ì ìš©ì„ ê¶Œê³ í•©ë‹ˆë‹¤.';
              const m = msg.toLowerCase();
              if (m.includes('sql') || m.includes('execute') && m.includes('statement')) {
                return 'SQL ì¸ì ì…˜: PreparedStatement(íŒŒë¼ë¯¸í„° ë°”ì¸ë”©) ì‚¬ìš© ë° ì…ë ¥ ê²€ì¦(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸) ì ìš©.';
              }
              if (m.includes('xss') || m.includes('<script')) {
                return 'XSS: ì¶œë ¥ ì‹œ HTML ì¸ì½”ë”©(ì˜ˆ: HtmlUtils.htmlEscape) ë˜ëŠ” í…œí”Œë¦¿ ìë™ ì´ìŠ¤ì¼€ì´í”„ ì‚¬ìš©.';
              }
              if (m.includes('ldap') || m.includes('ldapinject')) {
                return 'LDAP ì¸ì ì…˜: íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ ë˜ëŠ” ì…ë ¥ ì´ìŠ¤ì¼€ì´í”„ ì‚¬ìš©.';
              }
              if (m.includes('xpath')) {
                return 'XPath ì¸ì ì…˜: ì‚¬ìš©ì ì…ë ¥ ì´ìŠ¤ì¼€ì´í”„ ë˜ëŠ” íŒŒë¼ë¯¸í„°í™” ì‚¬ìš©.';
              }
              if (m.includes('exec') || m.includes('runtime.exec') || m.includes('process')) {
                return 'OS ëª…ë ¹ ì‹¤í–‰: ì™¸ë¶€ ì…ë ¥ì„ ëª…ë ¹ì— ì§ì ‘ ì‚¬ìš©í•˜ì§€ ë§ê³  ì•ˆì „í•œ API ì‚¬ìš©/í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì ìš©.';
              }
              return 'ì…ë ¥ ê²€ì¦, ìµœì†Œ ê¶Œí•œ, ì¶œë ¥ ì¸ì½”ë”© ì ìš©ì„ ê¶Œê³ í•©ë‹ˆë‹¤.';
            }

            // read semgrep results
            let semgrep = {};
            if (fs.existsSync('semgrep-results.json')) {
              try {
                semgrep = JSON.parse(fs.readFileSync('semgrep-results.json','utf8') || '{}');
              } catch(e) {
                core.info('Failed to parse semgrep-results.json: ' + String(e));
                semgrep = {};
              }
            }
            const results = Array.isArray(semgrep.results) ? semgrep.results : [];

            const findings = results.map(r => {
              const path = r.path || ((r.extra && r.extra.metadata && r.extra.metadata.file) || '-');
              const msg = (r.extra && r.extra.message) || r.message || '';
              let line = '-';
              if (r.start && typeof r.start === 'object') line = r.start.line || '-';
              else if (r.start) line = r.start;
              const sev = normSeverity((r.extra && r.extra.severity) || r.severity);
              const cwe = detectCWE(msg);
              const rec = recommend(msg);
              return {file: path, line, severity: sev, cwe, msg, rec};
            });

            // make summary decision
            let overall = 'ì·¨ì•½ì  ì—†ìŒ (ìë™ ë¶„ì„)';
            if (findings.some(f => f.severity === 'CRITICAL')) overall = 'ì·¨ì•½ì  ìˆìŒ (Block)';
            else if (findings.some(f => f.severity === 'MEDIUM')) overall = 'ìˆ˜ë™ ê²€í†  í•„ìš”';

            // build markdown
            const lines = [];
            lines.push(`# ğŸ¤– AI Security Review (ìë™ ë¦¬í¬íŠ¸) - ${new Date().toISOString().slice(0,10)}`);
            lines.push('');
            lines.push(`**ì „ì²´ íŒë‹¨:** ${overall}`);
            lines.push('');
            lines.push('**ìš”ì•½:**');
            if (findings.length > 0) {
              const crit = findings.filter(f => f.severity==='CRITICAL').length;
              const med = findings.filter(f => f.severity==='MEDIUM').length;
              const low = findings.filter(f => f.severity==='LOW').length;
              lines.push(`- ì´ ë°œê²¬ í•­ëª©: ${findings.length} (Critical: ${crit}, Medium: ${med}, Low: ${low})`);
            } else {
              lines.push('- íƒì§€ëœ ì·¨ì•½ì  ì—†ìŒ (ìë™ ê¸°ì¤€)');
            }
            lines.push('');
            lines.push('## ìƒì„¸ í•­ëª©');
            lines.push('');
            if (findings.length > 0) {
              lines.push('|íŒŒì¼|ë¼ì¸|ì‹¬ê°ë„|CWE|ë¬¸ì œ ìš”ì•½|ê¶Œê³ (í•œê¸€)|');
              lines.push('|---|---:|---|---|---|---|');
              for (const f of findings) {
                const file = String(f.file).replace(/\|/g,'\\|');
                const msg = String(f.msg).replace(/\n/g,' ').replace(/\|/g,'\\|');
                const rec = String(f.rec).replace(/\n/g,' ').replace(/\|/g,'\\|');
                lines.push(`|${file}|${f.line}|${f.severity}|${f.cwe || '-'}|${msg}|${rec}|`);
              }
            } else {
              lines.push('ì·¨ì•½ì  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
            lines.push('');
            lines.push('## ê¶Œê³  ìš”ì•½');
            if (findings.length > 0) {
              lines.push('- ê° í•­ëª©ë³„ ê¶Œê³ ë¥¼ í‘œì˜ `ê¶Œê³ (í•œê¸€)` ì—´ì—ì„œ í™•ì¸í•˜ì„¸ìš”.');
              lines.push('- ì¼ë°˜ ê¶Œê³ : PreparedStatement(íŒŒë¼ë¯¸í„° ë°”ì¸ë”©), ì…ë ¥ ê²€ì¦(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸), ì¶œë ¥ ì¸ì½”ë”©, ìµœì†Œ ê¶Œí•œ ì ìš©.');
            } else {
              lines.push('- ìë™ë¶„ì„ìœ¼ë¡œëŠ” ì·¨ì•½ì  ì—†ìŒ. ë‹¨, ì¤‘ìš” ë¡œì§ì€ ìˆ˜ë™ ê²€í†  ê¶Œì¥.');
            }
            lines.push('');
            lines.push('---');
            lines.push('_ìë™ ìƒì„± ë¦¬í¬íŠ¸ â€” ë‹´ë‹¹ì ê²€í†  í•„ìš”_');

            // write report.md
            fs.writeFileSync('report.md', lines.join('\\n'), {encoding:'utf8'});
            core.info('report.md created (length:' + fs.readFileSync('report.md','utf8').length + ')');

      - name: Show report head (for logs)
        run: |
          if [ -f report.md ]; then
            echo "===== report.md (head) ====="
            sed -n '1,160p' report.md || true
            echo "===== end head ====="
          else
            echo "report.md not found"
          fi

      - name: Post report (PR comment or create Issue)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = 'report.md';
            const bodyFull = fs.existsSync(path) ? fs.readFileSync(path,'utf8') : 'No report generated.';
            const bodyToPost = (bodyFull.length > 8000) ? bodyFull.slice(0,8000) + '\n\n(ë¦¬í¬íŠ¸ ìš”ì•½ë§Œ ê²Œì‹œë¨; ì „ì²´ëŠ” artifact ì°¸ì¡°)' : bodyFull;
            const isPR = !!context.payload.pull_request;
            if (isPR) {
              const issue_number = context.payload.pull_request.number;
              const resp = await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body: `### ğŸ¤– AI Security Review (ìë™ ìš”ì•½)\n\n${bodyToPost}\n\n_ìë™ ìƒì„± â€” ë‹´ë‹¹ì ê²€í†  í•„ìš”_`
              });
              core.info('Posted PR comment. API status: ' + (resp.status || 'unknown'));
            } else {
              const resp = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[AI Security Scan] ìë™ ë¦¬í¬íŠ¸ - ${new Date().toISOString().slice(0,10)}`,
                body: `ë¸Œëœì¹˜: ${context.ref}\n\n${bodyToPost}\n\n_ìë™ ìƒì„± ë¦¬í¬íŠ¸_`
              });
              core.info('Created issue. API status: ' + (resp.status || 'unknown'));
            }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-artifacts
          path: |
            semgrep-results.json
            report.md
