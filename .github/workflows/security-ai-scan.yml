name: Security AI Scan (external script + semgrep)

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  MAX_FILE_BYTES: "200000"
  MAX_FILES: "8"
  OPENAI_MODEL: "gpt-4o-mini"

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies (semgrep, requests)
        run: |
          python -m pip install --upgrade pip
          pip install semgrep requests

      - name: Run semgrep (builtin rules)
        run: |
          semgrep --config p/ci --json --output semgrep-results.json || true
          echo "semgrep finished, results saved to semgrep-results.json (if any)."

      - name: Run external security script (python)
        run: |
          python .github/scripts/security_scan.py
        env:
          OPENAI_API_KEY: ${{ secrets.SKLEE_OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_FILE_BYTES: ${{ env.MAX_FILE_BYTES }}
          MAX_FILES: ${{ env.MAX_FILES }}
          OPENAI_MODEL: ${{ env.OPENAI_MODEL }}

      - name: Debug: show generated reports (for troubleshooting)
        run: |
          echo "=== Artifacts present ==="
          ls -la ai_report.md ai_summary.json semgrep-results.json || true
          echo
          echo "=== ai_report.md (head) ==="
          if [ -f ai_report.md ]; then sed -n '1,200p' ai_report.md; else echo "(no ai_report.md)"; fi
          echo
          echo "=== ai_summary.json (head) ==="
          if [ -f ai_summary.json ]; then sed -n '1,200p' ai_summary.json; else echo "(no ai_summary.json)"; fi
          echo
          echo "=== GitHub event file (head) ==="
          if [ -n "${GITHUB_EVENT_PATH:-}" ] && [ -f "${GITHUB_EVENT_PATH}" ]; then sed -n '1,200p' "${GITHUB_EVENT_PATH}"; else echo "(no event file)"; fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-artifacts
          path: |
            semgrep-results.json
            ai_report.md
            ai_summary.json
