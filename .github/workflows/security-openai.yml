name: "PR Vulnerability Analysis (OpenAI)"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  analyze-diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (fetch full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: |
          cd .github/scripts
          npm ci

      - name: Prepare diff file
        id: diff
        run: |
          # For pull_request: compare head sha to base sha
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE=${{ github.event.pull_request.base.sha }}
            HEAD=${{ github.event.pull_request.head.sha }}
            git fetch --no-tags origin $BASE $HEAD
            git diff $BASE $HEAD > pr.diff || true
          else
            # fallback: last commit diff
            git diff HEAD^ HEAD > pr.diff || true
          fi
          wc -c pr.diff || true
          echo "::set-output name=diff_path::${GITHUB_WORKSPACE}/.github/scripts/pr.diff"

      - name: Move diff into script folder
        run: |
          mv pr.diff .github/scripts/pr.diff || true
          ls -l .github/scripts

      - name: Run vulnerability analysis
        env:
          OPENAI_API_KEY: ${{ secrets.SKLEE_OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
        run: |
          node .github/scripts/analyze.js
